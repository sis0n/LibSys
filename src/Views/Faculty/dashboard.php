<?php
use App\Repositories\FacultyBorrowingHistoryRepository;

$facultyHistoryRepo = new FacultyBorrowingHistoryRepository();

$userId = $_SESSION['user_data']['user_id'];

date_default_timezone_set('Asia/Manila');
$today = new DateTime('today');


$stats = $facultyHistoryRepo->getBorrowingStats($userId);
$totalBorrowed = $stats['currently_borrowed'];
$totalOverdue = $stats['total_overdue'];   

$allHistoryRecords = $facultyHistoryRepo->getPaginatedBorrowingHistory($userId, 100, 0);

$currentBorrowedBooks = [];
foreach ($allHistoryRecords as $record) {

    if ($record['status'] === 'borrowed') {
        $currentBorrowedBooks[] = $record;
    }
}
?>

<body class="min-h-screen p-6">
    <div class="mb-6">
        <h2 class="text-2xl font-bold mb-4">Dashboard</h2>
        <div class="text-gray-700">Here's your library overview for today.</div>
    </div>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">

        <div
            class="relative bg-[var(--color-card)] shadow-md rounded-lg border border-[var(--color-border)] p-4 overflow-hidden">
            <div class="absolute top-0 left-0 h-full w-1 bg-[var(--color-orange-500)]"></div>
            <div class="absolute top-3 right-3 text-xl text-[var(--color-orange-500)]"><i class="ph ph-books"></i></div>
            <h3 class="text-sm text-gray-600">Books Borrowed</h3>
            <p class="text-3xl font-bold mt-2"><?= $totalBorrowed ?></p> <span class="text-sm text-gray-500">Currently borrowed</span>
        </div>

        <div
            class="relative bg-[var(--color-card)] shadow-md rounded-lg border border-[var(--color-border)] p-4 overflow-hidden">
            <div class="absolute top-0 left-0 h-full w-1 bg-[var(--color-destructive)]"></div>
            <div class="absolute top-3 right-3 text-xl text-[var(--color-destructive)]"><i class="ph ph-warning"></i>
            </div>
            <h3 class="text-sm text-gray-600">Overdue Books</h3>
            <p class="text-3xl font-bold mt-2 text-[var(--color-destructive)]"><?= $totalOverdue ?></p> <span class="text-sm text-gray-500">Need attention</span>
        </div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <div
            class="bg-[var(--color-card)] shadow-md rounded-lg border border-[var(--color-border)] p-4 border-t-4 border-t-[var(--color-orange-500)]">
            <h4 class="text-lg font-semibold mb-2">Currently Borrowed</h4>
            <p class="text-sm text-gray-600 mb-4">Books you need to return</p>

            <?php if (empty($currentBorrowedBooks)): ?>
                <div class="text-center text-gray-500 p-4">
                    <i class="ph ph-book-open text-4xl mb-2"></i>
                    <p>You have no borrowed books.</p>
                </div>
            <?php else: ?>
                <?php foreach ($currentBorrowedBooks as $book): ?>
                    <?php
                    $dueDate = new DateTime($book['due_date']);
                    $isOverdue = ($dueDate < $today && $book['status'] === 'borrowed');
                    ?>
                    <div
                        class="bg-[var(--color-orange-50)] border border-[var(--color-border)] rounded-md p-3 mb-3 flex justify-between items-center">
                        <div>
                            <p class="font-medium"><?= htmlspecialchars($book['title']) ?></p>
                            <p class="text-sm text-gray-600">by <?= htmlspecialchars($book['author']) ?></p>
                            <p class="text-xs text-gray-500">Due: <?= $dueDate->format('F j, Y') ?></p>
                        </div>

                        <?php if ($isOverdue): ?>
                            <span class="bg-[var(--color-destructive)] text-white px-3 py-1 text-xs rounded-full">Overdue</span>
                        <?php else: ?>
                            <span class="bg-[var(--color-orange-500)] text-white px-3 py-1 text-xs rounded-full">Borrowed</span>
                        <?php endif; ?>
                    </div>
                <?php endforeach; ?>
            <?php endif; ?>
        </div>

        <div
            class="bg-[var(--color-card)] shadow-md rounded-lg border border-[var(--color-border)] p-4 border-t-4 border-t-[var(--color-green-500)]">
            <h4 class="text-lg font-semibold mb-2">Quick Actions</h4>
            <p class="text-sm text-gray-600 mb-4">Common tasks</p>

            <div class="space-y-3">
                <a href="<?= BASE_URL ?>/faculty/bookCatalog"
                    class="flex items-start gap-3 bg-[var(--color-orange-50)] border border-[var(--color-border)] rounded-md p-3 hover:bg-[var(--color-orange-100)] transition">
                    <i class="ph ph-magnifying-glass text-lg mt-0.5"></i>
                    <span>
                        <span class="block font-medium">Search Books</span>
                        <span class="block text-xs text-gray-500">Find books in our catalog</span>
                    </span>
                </a>

                <a href="<?= BASE_URL ?>/faculty/qrBorrowingTicket"
                    class="flex items-start gap-3 bg-[var(--color-green-50)] border border-[var(--color-border)] rounded-md p-3 hover:bg-[var(--color-green-100)] transition">
                    <i class="ph ph-qr-code text-lg mt-0.5"></i>
                    <span>
                        <span class="block font-medium">Generate QR Ticket</span>
                        <span class="block text-xs text-gray-500">For borrowing books</span>
                    </span>
                </a>

                <a href="<?= BASE_URL ?>/faculty/borrowingHistory"
                    class="flex items-start gap-3 bg-[var(--color-amber-50)] border border-[var(--color-border)] rounded-md p-3 hover:bg-[var(--color-amber-100)] transition">
                    <i class="ph ph-clock-counter-clockwise text-lg mt-0.5"></i>
                    <span>
                        <span class="block font-medium">View History</span>
                        <span class="block text-xs text-gray-500">Check your borrowing history</span>
                    </span>
                </a>

            </div>
        </div>

    </section>
</body>